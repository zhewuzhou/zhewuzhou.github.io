<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>数据库性能之翼：SQL 语句运行时编译 - Studying & Blogging</title><meta name=Description content="Keep Moving, Keep Learning"><meta property="og:title" content="数据库性能之翼：SQL 语句运行时编译"><meta property="og:description" content="数据库性能之翼：SQL 语句运行时编译 摘要 现代服务器的一大特点是内存越来越大，对于运行在这些服务器上的数据库，性能的瓶颈是 CPU 而非内存；然而传统 SQL 执行模型即“火山模型” 诞生于内存是瓶颈的年代，其以行为单位的迭代执行过程虽然灵活，但对 CPU 非常不友好。
在这个大背景下，SQL 语句运行时编译技术应运而生，为传统的关系型数据库的 SQL 执行性能插上翅膀。
一些 SQL 编译的实现如下：
 Apache Spark Tungsten 引擎运行时将 SQL 语句的 Where 部分转换成抽象语法树，然后再讲抽象语法树运行时编译成 Java 字节码。 Oracle 数据库将 SQL 语句运行时转换为 C\C++ 代码，然后将其编译为机器码。 Postgres 11 中提供了基于 LLVM 的即时编译(JIT) 的 SQL 语句执行引擎。有实验证明 Postgres 上 SQL 语句编译技术能够将 Postgres 的事务处理能力提升20%之500%。  随着 CPU 和多核瓶颈日益凸显，SQL 语句编译技术会成为重要的数据库性能提升技术。希望读者通过本篇博客能够了对 SQL 编译技术有个大概的认识。
为什么要进行 SQL 编译 通用（抽象） vs 定向优化 SQL 是一个非常优秀的抽象模型；对于使用者来讲，SQL 简单易用，不用关心 SQL 背后的诸如存储、同步及先写日志等细节；从而使得：
 SQL 可以运行在任何一台计算机上 开发人员不需要关心 SQL 语句的执行过程，通过陈述的方式描述业务逻辑  另外一方面，现代的计算机硬件在不断进步，SQL 语句运行速度的关键是针对这些硬件进行定向优化。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/"><meta property="og:image" content="https://zhewuzhou.github.io/logo.png"><meta property="article:published_time" content="2018-09-13T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-20T16:51:45+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhewuzhou.github.io/logo.png"><meta name=twitter:title content="数据库性能之翼：SQL 语句运行时编译"><meta name=twitter:description content="数据库性能之翼：SQL 语句运行时编译 摘要 现代服务器的一大特点是内存越来越大，对于运行在这些服务器上的数据库，性能的瓶颈是 CPU 而非内存；然而传统 SQL 执行模型即“火山模型” 诞生于内存是瓶颈的年代，其以行为单位的迭代执行过程虽然灵活，但对 CPU 非常不友好。
在这个大背景下，SQL 语句运行时编译技术应运而生，为传统的关系型数据库的 SQL 执行性能插上翅膀。
一些 SQL 编译的实现如下：
 Apache Spark Tungsten 引擎运行时将 SQL 语句的 Where 部分转换成抽象语法树，然后再讲抽象语法树运行时编译成 Java 字节码。 Oracle 数据库将 SQL 语句运行时转换为 C\C++ 代码，然后将其编译为机器码。 Postgres 11 中提供了基于 LLVM 的即时编译(JIT) 的 SQL 语句执行引擎。有实验证明 Postgres 上 SQL 语句编译技术能够将 Postgres 的事务处理能力提升20%之500%。  随着 CPU 和多核瓶颈日益凸显，SQL 语句编译技术会成为重要的数据库性能提升技术。希望读者通过本篇博客能够了对 SQL 编译技术有个大概的认识。
为什么要进行 SQL 编译 通用（抽象） vs 定向优化 SQL 是一个非常优秀的抽象模型；对于使用者来讲，SQL 简单易用，不用关心 SQL 背后的诸如存储、同步及先写日志等细节；从而使得：
 SQL 可以运行在任何一台计算机上 开发人员不需要关心 SQL 语句的执行过程，通过陈述的方式描述业务逻辑  另外一方面，现代的计算机硬件在不断进步，SQL 语句运行速度的关键是针对这些硬件进行定向优化。"><meta name=application-name content="Studying & Blogging"><meta name=apple-mobile-web-app-title content="Studying & Blogging"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/><link rel=prev href=https://zhewuzhou.github.io/posts/spring_aop_trap/><link rel=next href=https://zhewuzhou.github.io/posts/weekly-paper-a-survey-of-b-tree-locking-techniques/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"数据库性能之翼：SQL 语句运行时编译","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhewuzhou.github.io\/posts\/sql_compilation_technology_for_performance\/"},"genre":"posts","keywords":"关系型数据库, SQL, SQL语句编译, 高性能, JIT","wordcount":359,"url":"https:\/\/zhewuzhou.github.io\/posts\/sql_compilation_technology_for_performance\/","datePublished":"2018-09-13T00:00:00+00:00","dateModified":"2020-12-20T16:51:45+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"zhewuzhou"},"author":{"@type":"Person","name":"zhewuzhou"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Studying & Blogging"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>zhewu's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/ title=GitHub><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Studying & Blogging"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>zhewu's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/ title=GitHub><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">数据库性能之翼：SQL 语句运行时编译</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>zhewuzhou</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/><i class="far fa-folder fa-fw"></i>数据库</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-09-13>2018-09-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 359 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 2 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#数据库性能之翼sql-语句运行时编译>数据库性能之翼：SQL 语句运行时编译</a><ul><li><a href=#摘要>摘要</a></li><li><a href=#为什么要进行-sql-编译>为什么要进行 SQL 编译</a><ul><li><a href=#通用抽象-vs-定向优化>通用（抽象） vs 定向优化</a></li><li><a href=#火山模型>火山模型</a></li></ul></li><li><a href=#sql-编译技术细节>SQL 编译技术细节</a></li><li><a href=#减少不必要的指令>减少不必要的指令</a></li><li><a href=#增加-cpu-缓存效率>增加 CPU 缓存效率</a></li><li><a href=#代码生成>代码生成</a><ul><li><a href=#代码到代码>代码到代码</a></li><li><a href=#jit>JIT</a></li></ul></li><li><a href=#作者的其他数据库文章链接>作者的其他数据库文章链接</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=数据库性能之翼sql-语句运行时编译>数据库性能之翼：SQL 语句运行时编译</h1><h2 id=摘要>摘要</h2><p>现代服务器的一大特点是内存越来越大，对于运行在这些服务器上的数据库，性能的瓶颈是 CPU 而非内存；然而传统 SQL 执行模型即“火山模型” 诞生于内存是瓶颈的年代，其以行为单位的迭代执行过程虽然灵活，但对 CPU 非常不友好。</p><p>在这个大背景下，SQL 语句运行时编译技术应运而生，为传统的关系型数据库的 SQL 执行性能插上翅膀。</p><p>一些 SQL 编译的实现如下：</p><ol><li>Apache Spark Tungsten 引擎运行时将 SQL 语句的 Where 部分转换成抽象语法树，然后再讲抽象语法树运行时编译成 Java 字节码。</li><li>Oracle 数据库将 SQL 语句运行时转换为 C\C++ 代码，然后将其编译为机器码。</li><li>Postgres 11 中提供了基于 LLVM 的即时编译(JIT) 的 <a href=https://www.postgresql.org/docs/11/static/jit-decision.html target=_blank rel="noopener noreffer">SQL 语句执行引擎</a>。有实验证明 Postgres 上 SQL 语句编译技术能够将 Postgres 的事务处理能力<a href=https://www.pgcon.org/2017/schedule/events/1092.en.html target=_blank rel="noopener noreffer">提升20%之500%</a>。</li></ol><p>随着 CPU 和多核瓶颈日益凸显，SQL 语句编译技术会成为重要的数据库性能提升技术。希望读者通过本篇博客能够了对 SQL 编译技术有个大概的认识。</p><h2 id=为什么要进行-sql-编译>为什么要进行 SQL 编译</h2><h3 id=通用抽象-vs-定向优化>通用（抽象） vs 定向优化</h3><p>SQL 是一个非常优秀的抽象模型；对于使用者来讲，SQL 简单易用，不用关心 SQL
背后的诸如存储、同步及先写日志等细节；从而使得：</p><ol><li>SQL 可以运行在任何一台计算机上</li><li>开发人员不需要关心 SQL 语句的执行过程，通过陈述的方式描述业务逻辑</li></ol><p>另外一方面，现代的计算机硬件在不断进步，SQL 语句运行速度的关键是针对这些硬件进行定向优化。</p><p>SQL 运行时编译正好可以弥补通用抽象和定向优化之间的性能差距。</p><h3 id=火山模型>火山模型</h3><p>火山模型是数据库成熟的 SQL 语句解释执行方案，该模型是一个数据库执行器实现中非常流行的“设计模式”。该设计模式将关系型代数中的每一种操作抽象成一个 Operator，整个 SQL 语句在这种情况下形成一个 Operator 树；通过自顶向下的调用 next 接口，火山模型能够以数据库行为单位处理数据。
<img class=lazyload src=/svg/loading.min.svg data-src=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/SQL.png data-srcset="https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/SQL.png, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/SQL.png 1.5x, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/SQL.png 2x" data-sizes=auto alt=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/SQL.png title=SQL>
<img class=lazyload src=/svg/loading.min.svg data-src=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Vocano-Model.png data-srcset="https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Vocano-Model.png, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Vocano-Model.png 1.5x, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Vocano-Model.png 2x" data-sizes=auto alt=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Vocano-Model.png title="Volcano Model"></p><p>火山模型有如下特点：</p><ol><li>首先该模型以数据行为单位处理数据，每一行数据的处理，都会调用 next 接口多次；当 SQL 语句涉及的数据行数特别多的情况下，next 的调用次数会相当大。</li><li>next 接口的调用，是通过虚函数机制；相比于直接调用函数，虚函数机制需要的 CPU 指令更多，因此也更加昂贵。</li><li>以行为单位的数据处理，会导致 CPU 缓存使用效率低下和一些不必要的复杂性；首先数据库必须记住处理到哪一行，以便处理跳到下一行；其次处理完一行后需要将下一行加载到 CPU 缓存中，而实际上 CPU 缓存所能存储的数据行数远不止一行。</li><li><a href=https://www.zhihu.com/question/52220920/answer/340220500 target=_blank rel="noopener noreffer">火山模型最大的好处是工程上非常干净</a>，每个Operator有良好的抽象，只需要关心自己负责的逻辑就可以，比如Filter只需要关心如何根据谓词过滤数据，Aggregates只需要关心如何聚合数据。</li></ol><p>一言以蔽之，火山模型首先会导致更多的 CPU 指令，更为严重的是会导致 CPU 缓存效率低下，严重影响数据库的性能；而 SQL 语句编译技术就是针对这些问题进行优化。</p><h2 id=sql-编译技术细节>SQL 编译技术细节</h2><h2 id=减少不必要的指令>减少不必要的指令</h2><p>从根本上讲，提高数据库性能的方法是减少 CPU 指令数量；有实验之处数据库处理事务过程中，正真有用的指令，即用于事务逻辑的指令<a href=https://15721.courses.cs.cmu.edu/spring2018/papers/02-inmemory/hstore-lookingglass.pdf target=_blank rel="noopener noreffer">不到5%</a>
<img class=lazyload src=/svg/loading.min.svg data-src=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/DB-Useful-Work.png data-srcset="https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/DB-Useful-Work.png, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/DB-Useful-Work.png 1.5x, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/DB-Useful-Work.png 2x" data-sizes=auto alt=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/DB-Useful-Work.png title=DB-Useful-Work>
SQL 语句编译成机器码的过程，就是通过优化有效的降低 CPU 指令数的过程。</p><h2 id=增加-cpu-缓存效率>增加 CPU 缓存效率</h2><p>火山模型以 Operator 为中心进行事务处理，其弊端非常明显；SQL 编译技术为了最大可能的将数据保留在 CPU 寄存器中，采取如下措施：</p><ol><li>以数据为中心，同事处理多行数据，而不是一行；自底向上，而不是自顶向下。
<img class=lazyload src=/svg/loading.min.svg data-src=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Volcano-VS-Push.png data-srcset="https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Volcano-VS-Push.png, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Volcano-VS-Push.png 1.5x, https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Volcano-VS-Push.png 2x" data-sizes=auto alt=https://blog-image-1258275666.cos.ap-chengdu.myqcloud.com/Volcano-VS-Push.png title=VS></li><li>SQL 通过 LLVM 编译成机器码，编译优化使得数据能够尽可能久的停留在CPU寄存器中。实际上编译成机器码使得 SQL 语句能够得到硬件和编译器优化技术进步带来的替身，这是火山模型无法匹敌的。</li><li>同一批数据尽可能久的停留在 CPU 寄存器中，即数据不变而 Operator 流转，相比于火山模型，这种方式更像是数据不断地被 Push 给 Operator，而不是 Operator Pull 数据。</li></ol><p>这种以多行数据为单位，基于 Push 的技术应用于数据库 SQL 执行引擎，可带来<a href=https://www.pgcon.org/2017/schedule/events/1092.en.html target=_blank rel="noopener noreffer">5倍</a>的性能提升。</p><h2 id=代码生成>代码生成</h2><h3 id=代码到代码>代码到代码</h3><p>这种方式基本上是将 SQL 语句转换成 C\C++ 代码，有如下特点：</p><ol><li>对于给定的 SQL 语句，通过模板将其替换为同等逻辑的 C\C++ 代码，然后编译成机器码</li><li>一般情况下会另起一个进程或者线程，运行诸如 gcc 等成熟的编译器，对生成的 C\C++ 代码进行一步编译</li><li>编译好的代码通过运行时链接，可调用数据库其他方法</li><li>这种方式能够带来 SQL 语句执行效率的提升，然而如果 SQL 语句过大，可能导致编译时间长，总体时间反而不如解释执行的情况。</li></ol><h3 id=jit>JIT</h3><p>这种方式并非将 SQL 语句直接编译成机器码，而是首先将其编译成中间代码，比如 LLVM IR，有如下特点：</p><ol><li>由于 JIT 的方式使得数据库编译器拥有 SQL 运行时的数据，通过数据生存周期分析等技术优化，有针对性的进行优化和编译，让数据能够尽可能久的停留在 CPU 缓存中；上述 Push 数据的 SQL 执行引擎成基于 JIT 实现。</li><li>SQL 语句编译并非没有代价，实际上编译时间和 SQL 语句的复杂程度是线性关系；由于编译器拥有运行时数据，且数据库引擎以一组数据单位，因此编译器可以实时评估收益，在执行下一组数据的时候在如下方式间灵活无缝的切换：</li></ol><ul><li>简单 SQL 语句解释执行</li><li>中等规模的SQL 语句不经优化编译成机器码执行</li><li>复杂的的 SQL 语句深度优化编译成机器码执行</li></ul><ol start=3><li>简单的<a href=https://15721.courses.cs.cmu.edu/spring2018/papers/03-compilation/kohn-icde2018.pdf target=_blank rel="noopener noreffer">算法</a>如下</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cpp data-lang=cpp><span class=c1>//Dispatch
</span><span class=c1></span><span class=n>dispatch</span><span class=p>(</span><span class=n>handleB</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span><span class=o>:</span>
  <span class=n>nextMorsel</span> <span class=o>=</span> <span class=n>grabMorsel</span><span class=p>()</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>handleB</span><span class=p>.</span><span class=n>isCompiled</span><span class=p>())</span><span class=o>:</span>
    <span class=n>handleB</span><span class=p>.</span><span class=n>fn</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>nextMorsel</span><span class=p>)</span>
  <span class=k>else</span><span class=o>:</span>
    <span class=n>VM</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>handleB</span><span class=p>.</span><span class=n>byteCode</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>nextMorsel</span><span class=p>)</span>
  <span class=n>choice</span> <span class=o>=</span> <span class=n>choice</span> <span class=o>=</span> <span class=n>extrapolatePipelineDurations</span><span class=p>(...)</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>choice</span> <span class=o>!=</span> <span class=n>DoNothing</span><span class=p>)</span><span class=o>:</span>
    <span class=n>unAsync</span><span class=p>(</span><span class=err>λ</span> <span class=o>-&gt;</span> <span class=n>handleB</span><span class=p>.</span><span class=n>fn</span> <span class=o>=</span> <span class=n>handleB</span><span class=p>.</span><span class=n>compile</span><span class=p>(</span><span class=n>choice</span><span class=p>))</span>

<span class=c1>//Evaluate
</span><span class=c1>// f: worker function
</span><span class=c1>// n: remaining tuples
</span><span class=c1>// w: active worker threads
</span><span class=c1></span><span class=n>extrapolatePipelineDurations</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span><span class=o>:</span>
  <span class=n>r0</span> <span class=o>=</span> <span class=n>avg</span><span class=p>(</span><span class=n>rateinthreadRates</span><span class=p>)</span>
  <span class=n>r1</span> <span class=o>=</span> <span class=n>r0</span><span class=o>*</span><span class=n>speedup1</span><span class=p>(</span><span class=n>f</span><span class=p>);</span> <span class=n>c1</span> <span class=o>=</span> <span class=n>ctime1</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
  <span class=n>r2</span> <span class=o>=</span> <span class=n>r0</span><span class=o>*</span><span class=n>speedup2</span><span class=p>(</span><span class=n>f</span><span class=p>);</span> <span class=n>c2</span> <span class=o>=</span> <span class=n>ctime2</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
  <span class=n>t0</span> <span class=o>=</span> <span class=n>n</span> <span class=o>/</span> <span class=n>r0</span> <span class=o>/</span> <span class=n>w</span>
  <span class=n>t1</span> <span class=o>=</span> <span class=n>c1</span> <span class=o>+</span> <span class=n>max</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=p>(</span><span class=n>w</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>r0</span><span class=o>*</span><span class=n>c1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=n>r1</span> <span class=o>/</span> <span class=n>w</span>
  <span class=n>t2</span> <span class=o>=</span> <span class=n>c2</span> <span class=o>+</span> <span class=n>max</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=p>(</span><span class=n>w</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>r0</span><span class=o>*</span><span class=n>c2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=n>r2</span> <span class=o>/</span> <span class=n>w</span>
  <span class=n>switchmin</span><span class=p>(</span><span class=n>t0</span><span class=p>,</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t2</span><span class=p>)</span><span class=o>:</span>
    <span class=k>case</span> <span class=nl>t0</span><span class=p>:</span> <span class=k>return</span> <span class=n>DoNothing</span>
    <span class=k>case</span> <span class=nl>t1</span><span class=p>:</span> <span class=k>return</span> <span class=n>Unoptimized</span>
    <span class=k>case</span> <span class=nl>t2</span><span class=p>:</span> <span class=k>return</span> <span class=n>Optimized</span>
</code></pre></td></tr></table></div></div><h2 id=作者的其他数据库文章链接>作者的其他数据库文章链接</h2><ol><li><a href=https://zhewuzhou.github.io/posts/sql_as_universe_language_in_data_world/ target=_blank rel="noopener noreffer">SQL：数据世界的通用语</a></li><li><a href=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ target=_blank rel="noopener noreffer">数据库性能之翼：SQL 语句运行时编译</a></li><li><a href=https://zhewuzhou.github.io/posts/weekly-paper-a-survey-of-b-tree-locking-techniques/ target=_blank rel="noopener noreffer">每周一论文：A Survey of B-Tree Locking Techniques</a></li><li><a href=https://zhewuzhou.github.io/posts/weekly-paper-an-empirical-evalution-of-in-memory-mvcc/ target=_blank rel="noopener noreffer">每周一论文：An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</a></li><li><a href=https://zhewuzhou.github.io/posts/database-indexes/ target=_blank rel="noopener noreffer">数据库索引数据结构总结</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-12-20</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/sql_compilation_technology_for_performance/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ data-title="数据库性能之翼：SQL 语句运行时编译" data-hashtags=关系型数据库,SQL,SQL语句编译,高性能,JIT><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ data-hashtag=关系型数据库><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ data-title="数据库性能之翼：SQL 语句运行时编译"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ data-title="数据库性能之翼：SQL 语句运行时编译"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://zhewuzhou.github.io/posts/sql_compilation_technology_for_performance/ data-title="数据库性能之翼：SQL 语句运行时编译"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/>关系型数据库</a>,&nbsp;<a href=/tags/sql/>SQL</a>,&nbsp;<a href=/tags/sql%E8%AF%AD%E5%8F%A5%E7%BC%96%E8%AF%91/>SQL语句编译</a>,&nbsp;<a href=/tags/%E9%AB%98%E6%80%A7%E8%83%BD/>高性能</a>,&nbsp;<a href=/tags/jit/>JIT</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/spring_aop_trap/ class=prev rel=prev title="Spring AOP：内部调用陷阱"><i class="fas fa-angle-left fa-fw"></i>Spring AOP：内部调用陷阱</a>
<a href=/posts/weekly-paper-a-survey-of-b-tree-locking-techniques/ class=next rel=next title="每周一论文：A Survey of B-Tree Locking Techniques">每周一论文：A Survey of B-Tree Locking Techniques<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zhewuzhou</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/twemoji/twemoji.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"XNEGAJ4RGK","algoliaIndex":"zhewuzhou.github.io","algoliaSearchKey":"200e37ab4b326abd73ff15c859620520","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-71202311-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-71202311-1" async></script></body></html>