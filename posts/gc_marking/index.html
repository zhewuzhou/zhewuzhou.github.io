<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>GC 标记算法：从分阶段标记到无停顿标记 - Studying & Blogging</title><meta name=Description content="Keep Moving, Keep Learning"><meta property="og:title" content="GC 标记算法：从分阶段标记到无停顿标记"><meta property="og:description" content="摘要 为什么需要关注垃圾回收器？ 垃圾回收关键 - 标记 根集合 CMS 回收器标记 G1 回收器标记  SATB 算法   C4/Z 回收器标记 结论 引用  摘要 垃圾回收作为 Java 语言的重要特性，把开发人员从繁重的内存管理中解放出来，极大的 提高了生产效率。尽管市面上有形形色色不同的垃圾回收器，Hotspot 自带且成熟的有：
 Serial GC Parallel GC Parallel Old GC (Parallel Compacting GC) Concurrent Mark & Sweep GC (or “CMS”) Garbage First (G1) GC(Java 9 默认)  Oracle 正在开发或者处于试验阶段的垃圾回收有：
 ZGC，高吞吐量，低延时的 GC，承诺最大垃圾回收造成的应用暂停时间不大于 10 ms， 无论堆和存活对象大小多少。1 Epsilon GC2 ，测试目的 GC  此外，还有不少非 Oracle 主导的 GC ，比如 Redhat 的 Shenandoah GC3 ，Azul 的 C4 GC 等。"><meta property="og:type" content="article"><meta property="og:url" content="https://zhewuzhou.github.io/posts/gc_marking/"><meta property="og:image" content="https://zhewuzhou.github.io/logo.png"><meta property="article:published_time" content="2018-08-27T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-13T22:55:27+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhewuzhou.github.io/logo.png"><meta name=twitter:title content="GC 标记算法：从分阶段标记到无停顿标记"><meta name=twitter:description content="摘要 为什么需要关注垃圾回收器？ 垃圾回收关键 - 标记 根集合 CMS 回收器标记 G1 回收器标记  SATB 算法   C4/Z 回收器标记 结论 引用  摘要 垃圾回收作为 Java 语言的重要特性，把开发人员从繁重的内存管理中解放出来，极大的 提高了生产效率。尽管市面上有形形色色不同的垃圾回收器，Hotspot 自带且成熟的有：
 Serial GC Parallel GC Parallel Old GC (Parallel Compacting GC) Concurrent Mark & Sweep GC (or “CMS”) Garbage First (G1) GC(Java 9 默认)  Oracle 正在开发或者处于试验阶段的垃圾回收有：
 ZGC，高吞吐量，低延时的 GC，承诺最大垃圾回收造成的应用暂停时间不大于 10 ms， 无论堆和存活对象大小多少。1 Epsilon GC2 ，测试目的 GC  此外，还有不少非 Oracle 主导的 GC ，比如 Redhat 的 Shenandoah GC3 ，Azul 的 C4 GC 等。"><meta name=application-name content="Studying & Blogging"><meta name=apple-mobile-web-app-title content="Studying & Blogging"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://zhewuzhou.github.io/posts/gc_marking/><link rel=prev href=https://zhewuzhou.github.io/posts/sql_as_universe_language_in_data_world/><link rel=next href=https://zhewuzhou.github.io/posts/spring_aop_trap/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"GC 标记算法：从分阶段标记到无停顿标记","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhewuzhou.github.io\/posts\/gc_marking\/"},"genre":"posts","keywords":"Java, GC-Marking, Pauseless-GC","wordcount":504,"url":"https:\/\/zhewuzhou.github.io\/posts\/gc_marking\/","datePublished":"2018-08-27T00:00:00+00:00","dateModified":"2020-12-13T22:55:27+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"zhewuzhou"},"author":{"@type":"Person","name":"zhewuzhou"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Studying & Blogging"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>zhewu's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/ title=GitHub><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Studying & Blogging"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>zhewu's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/ title=GitHub><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">GC 标记算法：从分阶段标记到无停顿标记</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>zhewuzhou</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/jvm/><i class="far fa-folder fa-fw"></i>JVM</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-08-27>2018-08-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 504 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#摘要a-idsec-a>摘要<a id=sec-></a></a></li><li><a href=#为什么需要关注垃圾回收器a-idsec-a>为什么需要关注垃圾回收器？<a id=sec-></a></a></li><li><a href=#垃圾回收关键---标记a-idsec-a>垃圾回收关键 - 标记<a id=sec-></a></a></li><li><a href=#根集合a-idsec-a>根集合<a id=sec-></a></a></li><li><a href=#cms-回收器标记a-idsec-a>CMS 回收器标记<a id=sec-></a></a></li><li><a href=#g1-回收器标记a-idsec-a>G1 回收器标记<a id=sec-></a></a><ul><li><a href=#satb-算法a-idsec-a>SATB 算法<a id=sec-></a></a></li></ul></li><li><a href=#c4z-回收器标记a-idsec-a>C4/Z 回收器标记<a id=sec-></a></a></li><li><a href=#结论a-idsec-a>结论<a id=sec-></a></a></li><li><a href=#引用>引用</a></li></ul></nav></div></div><div class=content id=content><ul><li><a href=#%e6%91%98%e8%a6%81 rel>摘要<a id=sec-></a></a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%85%b3%e6%b3%a8%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8 rel>为什么需要关注垃圾回收器？<a id=sec-></a></a></li><li><a href=#%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%85%b3%e9%94%ae---%e6%a0%87%e8%ae%b0 rel>垃圾回收关键 - 标记<a id=sec-></a></a></li><li><a href=#%e6%a0%b9%e9%9b%86%e5%90%88 rel>根集合<a id=sec-></a></a></li><li><a href=#cms-%e5%9b%9e%e6%94%b6%e5%99%a8%e6%a0%87%e8%ae%b0 rel>CMS 回收器标记<a id=sec-></a></a></li><li><a href=#g1-%e5%9b%9e%e6%94%b6%e5%99%a8%e6%a0%87%e8%ae%b0 rel>G1 回收器标记<a id=sec-></a></a><ul><li><a href=#satb-%e7%ae%97%e6%b3%95 rel>SATB 算法<a id=sec-></a></a></li></ul></li><li><a href=#c4z-%e5%9b%9e%e6%94%b6%e5%99%a8%e6%a0%87%e8%ae%b0 rel>C4/Z 回收器标记<a id=sec-></a></a></li><li><a href=#%e7%bb%93%e8%ae%ba rel>结论<a id=sec-></a></a></li><li><a href=#%e5%bc%95%e7%94%a8 rel>引用</a></li></ul><h1 id=摘要a-idsec-a>摘要<a id=sec-></a></h1><p>垃圾回收作为 Java 语言的重要特性，把开发人员从繁重的内存管理中解放出来，极大的 提高了生产效率。尽管市面上有形形色色不同的垃圾回收器，Hotspot 自带且成熟的有：</p><ol><li>Serial GC</li><li>Parallel GC</li><li>Parallel Old GC (Parallel Compacting GC)</li><li>Concurrent Mark & Sweep GC (or “CMS”)</li><li>Garbage First (G1) GC(Java 9 默认)</li></ol><p>Oracle 正在开发或者处于试验阶段的垃圾回收有：</p><ol><li>ZGC，高吞吐量，低延时的 GC，承诺最大垃圾回收造成的应用暂停时间不大于 10 ms， 无论堆和存活对象大小多少。<sup><a id=fnr.1 class=footref href=#fn.1>1</a></sup></li><li>Epsilon GC<sup><a id=fnr.2 class=footref href=#fn.2>2</a></sup> ，测试目的 GC</li></ol><p>此外，还有不少非 Oracle 主导的 GC ，比如 Redhat 的 Shenandoah GC<sup><a id=fnr.3 class=footref href=#fn.3>3</a></sup> ，Azul 的 C4 GC 等。</p><p>形形色色的垃圾回收器让人眼花缭乱，遑论繁多的配置参数；本文试图通过提供一组通用 的视角，使得开发人员可以透过现象看本质，更好的理解和使用垃圾回收器，本篇文章主 要关注垃圾回收器的标记过程。</p><h1 id=为什么需要关注垃圾回收器a-idsec-a>为什么需要关注垃圾回收器？<a id=sec-></a></h1><p>在回答以上问题之前，有一个根本的问题需要回答，那就是作为一个应用程序开发人员， 为什么需要关注垃圾回收器？</p><p>实际上，尽管垃圾回收器在大多数情况下都是高效的，以至于大多数开发人员根本没有察 觉到它的存在；然而在另外一些场景下：</p><ol><li>垃圾回收器并不意味着没有内存泄露。<sup><a id=fnr.4 class=footref href=#fn.4>4</a></sup></li><li>垃圾回收器可能导致超过 30s 的应用暂停。<sup><a id=fnr.5 class=footref href=#fn.5>5</a></sup></li></ol><p>因此，即使作为应用程序开发人员，了解和学习垃圾回收器也是必要的，至少在遇到上面 两种情况的时候，可以是的开发人员更快的解决问题。</p><h1 id=垃圾回收关键---标记a-idsec-a>垃圾回收关键 - 标记<a id=sec-></a></h1><p>程序运行过程中产生的无用对象即已死对象。对于一个程序员来讲，利用经验或者的知识 可以轻易判断一个对象已死；垃圾回收器作为一个程序，并没有可利用的经验或者知识来 做出同样的判断，因之，通过程序判断对象已死的方式如下：</p><ol><li>编译时分析</li><li>引用计数</li><li>可达性分析</li></ol><p>本文主要讨论的主题是 JVM 上的垃圾回收，而在 JVM 上目前已知的垃圾回收器都基于可 达性分析；因此本文的所有描述都基于可达性分析算法。</p><p>如果一个对象可以通过当前活跃的线程“可达”，那么就判定该对象为存活对象。例如对象 对象的引用直接在活跃线程的栈上面，此种情况可称为直接可达；如果该对象持有其对象 的引用，那么这些其他对象亦可称之为可达。因此，可达性分析的关键就在于找出直接可 达的对象，这些直接可达的对象也被称为“根集合”。</p><p>可达性分析的关键在于找出那些可达也即存活的对象，其他的对象就可以视为垃圾进行回 收。那么那些对象可以算作“根集合”？</p><h1 id=根集合a-idsec-a>根集合<a id=sec-></a></h1><p>在 ZGC 中跟集合如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c++ data-lang=c++>  <span class=k>class</span> <span class=nc>ZRootsIterator</span> <span class=p>{</span>
    <span class=k>private</span><span class=o>:</span>
      <span class=n>ZOopStorageIterator</span> <span class=n>_vm_weak_handles_iter</span><span class=p>;</span>
      <span class=n>ZOopStorageIterator</span> <span class=n>_jni_handles_iter</span><span class=p>;</span>
      <span class=n>ZOopStorageIterator</span> <span class=n>_jni_weak_handles_iter</span><span class=p>;</span>
      <span class=n>ZOopStorageIterator</span> <span class=n>_string_table_iter</span><span class=p>;</span>

      <span class=kt>void</span> <span class=nf>do_universe</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_vm_weak_handles</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_jni_handles</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_jni_weak_handles</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_object_synchronizer</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_management</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_jvmti_export</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_jvmti_weak_export</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_jfr_weak</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_system_dictionary</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_class_loader_data_graph</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_threads</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_code_cache</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>
      <span class=kt>void</span> <span class=nf>do_string_table</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>);</span>

      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_universe</span><span class=o>&gt;</span>                  <span class=n>_universe</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_object_synchronizer</span><span class=o>&gt;</span>       <span class=n>_object_synchronizer</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_management</span><span class=o>&gt;</span>                <span class=n>_management</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_jvmti_export</span><span class=o>&gt;</span>              <span class=n>_jvmti_export</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_jvmti_weak_export</span><span class=o>&gt;</span>         <span class=n>_jvmti_weak_export</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_jfr_weak</span><span class=o>&gt;</span>                  <span class=n>_jfr_weak</span><span class=p>;</span>
      <span class=n>ZSerialOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_system_dictionary</span><span class=o>&gt;</span>         <span class=n>_system_dictionary</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_vm_weak_handles</span><span class=o>&gt;</span>         <span class=n>_vm_weak_handles</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_jni_handles</span><span class=o>&gt;</span>             <span class=n>_jni_handles</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_jni_weak_handles</span><span class=o>&gt;</span>        <span class=n>_jni_weak_handles</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_class_loader_data_graph</span><span class=o>&gt;</span> <span class=n>_class_loader_data_graph</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_threads</span><span class=o>&gt;</span>                 <span class=n>_threads</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_code_cache</span><span class=o>&gt;</span>              <span class=n>_code_cache</span><span class=p>;</span>
      <span class=n>ZParallelOopsDo</span><span class=o>&lt;</span><span class=n>ZRootsIterator</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ZRootsIterator</span><span class=o>::</span><span class=n>do_string_table</span><span class=o>&gt;</span>            <span class=n>_string_table</span><span class=p>;</span>

    <span class=k>public</span><span class=o>:</span>
      <span class=n>ZRootsIterator</span><span class=p>();</span>
      <span class=o>~</span><span class=n>ZRootsIterator</span><span class=p>();</span>

      <span class=kt>void</span> <span class=nf>oops_do</span><span class=p>(</span><span class=n>OopClosure</span><span class=o>*</span> <span class=n>cl</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>visit_jvmti_weak_export</span> <span class=o>=</span> <span class=nb>false</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></td></tr></table></div></div><p>尽管源码中用于枚举根集合的类型有超过十种，但大体上，可以归纳为三类：</p><ol><li>包含指向堆栈引用的全局变量。</li><li>包含指向堆栈引用的寄存器变量。</li><li>包含指向堆栈引用的栈内变量。</li></ol><p>现在垃圾回收器可以基于以上的根集合来枚举存活对象；为了降低应用程序响应时间，现 代的垃圾回收器基本都是并行增量标记；然而标记过程中仍然会遇到很多挑战：</p><ol><li>应用程序线程将一个未标记的对象引用读入 CPU 缓存，然后从内存中删除该对象。</li><li>未标记的对象被存储到已经标记的区域。</li></ol><p>为了解决类似上述的问题，垃圾回收器的设计者们需要考虑一下问题：</p><ol><li>Stop The World 是简单粗暴的问题解决办法，可以使得 GC 标记尽可能精准；但这是 以应用程序响应时间为代价的，如何在标记过程中尽量避免 Stop The World?</li><li>整个标记过程需要全局扫描和跟踪堆上的对象，时间相对较长，为了使得必要的 Stop The World 尽量短，有必要对标记过程进行切分，使得标记过程分成不同的阶段，如何 划分不同的阶段？</li></ol><h1 id=cms-回收器标记a-idsec-a>CMS 回收器标记<a id=sec-></a></h1><p>CMS 算法标记过程一般描述：</p><ul><li>初始标记(initial-mark)：从GC Root开始，仅扫描与根节点直接关联的对象并标记， 这个过程需要 Stop The World，但是GC Root数量有限，因此时间较短</li><li>并发标记(concurrent-marking)：这个阶段在初始标记的基础上继续向下进行遍历标记。 这个阶段与用户线程并发执行，因此不停顿</li><li>重新标记(remark)：重新标记阶段会对堆上的对象进行扫描，以对并发标记阶段遭到破 坏的对象引用关系进行修复，以保证执行清理之前对象引用关系是正确的。这一阶段需 要STW，时间也比较短暂</li></ul><p>需要说明的是在 CMS 一个垃圾回收的周期中，在对象或者一组对象重新分配的时候，使 用 card marking write barrier 来追踪对象的变化<sup><a id=fnr.6 class=footref href=#fn.6>6</a></sup> ，且在初始标记和重新标记 的时候引入 Stop The World</p><h1 id=g1-回收器标记a-idsec-a>G1 回收器标记<a id=sec-></a></h1><p>G1 的标记过程一般描述：</p><ul><li>初始标记(initial-marking)：需要 Stop The World， 扫描根集合，标记所有从根集 合可直接到达的对象并将它们的字段压入扫描栈 （marking stack）中等到后续扫描。 G1使。在分代式G1模式中，初始标记阶段借用 young generation GC 的暂停， 因而没 有额外的单独的暂停阶段。</li><li>并发标记(concurrent-marking)：跟应用程序并行， 不断从扫描栈取出引用递归扫描 整个堆里的对象图。每扫描到一个对象就会对其标记，并将其字段压入扫描栈。重复扫 描过程直到扫描栈清空。</li><li>最终标记(remark)： 需要 Stop The World，在完成并发标记后，每个Java线程还会有 一些剩下的由 write barrier 记录的引用尚未处理。这个阶段就负责把剩下的引用处 理完。</li></ul><h2 id=satb-算法a-idsec-a>SATB 算法<a id=sec-></a></h2><p>G1 使用的是 SATB 标记算法，主要应用于垃圾收集的并发标记阶段，解决了CMS 垃圾收 集器重新标记阶段长时间 Stop The World 的潜在风险。其算法全称是 Snapshot At The Beginning，由字面理解，是垃圾回收器开始时活着的对象的一个快照。它是通过 “根集合”穷举可达对象得到的，穷举过程中采用了三色标记法：</p><ul><li>白：对象没有被标记到，标记阶段结束后，会被当做垃圾回收掉。</li><li>灰：对象被标记了，但是它的field还没有被标记或标记完。</li><li>黑：对象被标记了，且它的所有field也被标记完了。</li></ul><p>在并发标记的过程中，应用程序可能会修改对象，使得一个白色对象被漏标</p><ul><li>应用程序插入了一个从黑色对象到该白色对象的新引用</li><li>应用程序删除了所有从灰色对象到该白色对象的直接或者间接引用。</li></ul><p>SATB 利用 write barrier 将所有即将被删除的引用关系的旧引用记录下来，最后以这 些旧引用为根 Stop The World 地重新扫描一遍即可避免漏标问题。 因此 G1 Remark阶 段 Stop The World 与 CMS 了的remark有一个本质上的区别，那就是这个暂停只需要扫 描有 write barrier 所追中对象为根的对象， 而 CMS 的 remark 需要重新扫描整个根 集合，因而CMS remark有可能会非常慢。</p><h1 id=c4z-回收器标记a-idsec-a>C4/Z 回收器标记<a id=sec-></a></h1><p>C4/Z 整个垃圾回收期间都不需要 Stop The World，是无停顿（Pauseless)垃圾回收器， 因此其标记过程也是并行的，因此 C4/Z 无视堆的大小和存活对象的多少，可以提供至多 10ms 的应用程序暂停，实际上这是非常保守的说法。</p><p>C4/Z 也是采用了增量的并行标记，跟 G1/CMS 相比，不同点在于：</p><ol><li>采用 Checkpoint 的方式，应用程序线程无需停顿，尤其是在初始标记，穷举根集合 的阶段，Checkpoint 是应用程序线程到达一个 Safepoint ，完成少量垃圾回收的工 作，然后继续业务逻辑，而垃圾回收器要等到所有的应用程序经过 Checkpoint 后， 才能开始一个垃圾回收周期；这一点跟 G1/CMS 完全不同，在G1/CMS initial mark 阶段所有的应用程序必须要处于 Safepoint 或者 Saferegion，因此存在所有的应用 程序线程需要等最慢到达 Safepoint 线程的情况。</li><li>在标记过程中，新对象分配在新的内存页上，新的内存页在标记过程中被忽略。</li><li>CMS/G1 使用 write barrier 由垃圾回收器线程完成追踪对象的变化，而 C4/Z 则使 用 read barrier 且由应用程序完成增量标记的任务；这种应用程序通过硬件中断自 行修复标记的过程也被成为 &ldquo;Self healing&rdquo;。<sup><a id=fnr.7 class=footref href=#fn.7>7</a></sup></li></ol><p>通过这些不同的技术，C4/Z 在整个标记过程中都不需要 Stop The World。</p><h1 id=结论a-idsec-a>结论<a id=sec-></a></h1><p>随着硬件的不断提升和用户体验要求不断被拔高，人们对应用程序的响应时间要求越来越 苛刻。在这个大背景下，垃圾回收器的标记技术也不短的在改变。</p><p>本文通过分析 CMS/G1/Z/C4 垃圾回收器的标记过程，揭示出 Java 垃圾回收器的一大技 术趋势，即在大内存堆的前提下尽 GC 可能的降低对应用程序的影响；从 CMS 的分阶段 增量标记，到 G1 通过 SATB 算法改正 remark 阶段的 Stop The World 的影响，再到 Z/C4甚至在标记阶段无需 Stop The World，莫不如此。</p><h1 id=引用>引用</h1><p><a id=fn.1 href=#fnr.1>1. </a><a href=https://wiki.openjdk.java.net/display/zgc/Main>https://wiki.openjdk.java.net/display/zgc/Main</a></p><p><a id=fn.2 href=#fnr.2>2. </a><a href=https://wiki.openjdk.java.net/display/shenandoah/Main>https://wiki.openjdk.java.net/display/shenandoah/Main</a></p><p><a id=fn.3 href=#fnr.3>3. </a><a href=http://openjdk.java.net/jeps/318>http://openjdk.java.net/jeps/318</a></p><p><a id=fn.4 href=#fnr.4>4. </a><a href=https://medium.com/@plumbr/memory-leaks-fallacies-and-misconce-8c79594a3986>https://medium.com/@plumbr/memory-leaks-fallacies-and-misconce-8c79594a3986</a></p><p><a id=fn.5 href=#fnr.5>5. </a><a href=https://medium.com/ai-build-techblog/jvm-garbage-collector-murder-mystery-1b6a4aec5117>https://medium.com/ai-build-techblog/jvm-garbage-collector-murder-mystery-1b6a4aec5117</a></p><p><a id=fn.6 href=#fnr.6>6. </a><a href=http://www.cs.ucsb.edu/~ckrintz/racelab/gc/papers/ossia-concurrent.pdf>http://www.cs.ucsb.edu/~ckrintz/racelab/gc/papers/ossia-concurrent.pdf</a></p><p><a id=fn.7 href=#fnr.7>7. </a><a href=https://www.usenix.net/events/vee05/full_papers/p46-click.pdf>https://www.usenix.net/events/vee05/full_papers/p46-click.pdf</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-12-13</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/gc_marking/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://zhewuzhou.github.io/posts/gc_marking/ data-title="GC 标记算法：从分阶段标记到无停顿标记" data-hashtags=Java,GC-Marking,Pauseless-GC><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://zhewuzhou.github.io/posts/gc_marking/ data-hashtag=Java><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://zhewuzhou.github.io/posts/gc_marking/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://zhewuzhou.github.io/posts/gc_marking/ data-title="GC 标记算法：从分阶段标记到无停顿标记"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://zhewuzhou.github.io/posts/gc_marking/ data-title="GC 标记算法：从分阶段标记到无停顿标记"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://zhewuzhou.github.io/posts/gc_marking/ data-title="GC 标记算法：从分阶段标记到无停顿标记"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/java/>Java</a>,&nbsp;<a href=/tags/gc-marking/>GC-Marking</a>,&nbsp;<a href=/tags/pauseless-gc/>Pauseless-GC</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/sql_as_universe_language_in_data_world/ class=prev rel=prev title=SQL：数据世界的通用语><i class="fas fa-angle-left fa-fw"></i>SQL：数据世界的通用语</a>
<a href=/posts/spring_aop_trap/ class=next rel=next title="Spring AOP：内部调用陷阱">Spring AOP：内部调用陷阱<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zhewuzhou</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/twemoji/twemoji.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"XNEGAJ4RGK","algoliaIndex":"zhewuzhou.github.io","algoliaSearchKey":"200e37ab4b326abd73ff15c859620520","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-71202311-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-71202311-1" async></script></body></html>